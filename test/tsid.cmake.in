# SPDX-License-Identifier: Unlicense

message(NOTICE "testing session-id conversions")

execute_process(COMMAND @CMAKE_COMMAND@ -E copy @CMAKE_SOURCE_DIR@/openssl/test/testsid.pem @CMAKE_CURRENT_BINARY_DIR@/sid-fff.p
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                COMMAND_ERROR_IS_FATAL ANY
)

# why doesn't original tsid script use loop?

message(NOTICE "p -> d")
execute_process(COMMAND @CMAKE_BINARY_DIR@/apps/openssl sess_id -in sid-fff.p -inform p -outform d
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                OUTPUT_FILE sid-f.d
                COMMAND_ERROR_IS_FATAL ANY
)

# p -> t

message(NOTICE "p -> p")
execute_process(COMMAND @CMAKE_BINARY_DIR@/apps/openssl sess_id -in sid-fff.p -inform p -outform p
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                OUTPUT_FILE sid-f.p
                COMMAND_ERROR_IS_FATAL ANY
)

message(NOTICE "d -> d")
execute_process(COMMAND @CMAKE_BINARY_DIR@/apps/openssl sess_id -in sid-f.d -inform d -outform d
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                OUTPUT_FILE sid-ff.d1
                COMMAND_ERROR_IS_FATAL ANY
)

# t -> d

message(NOTICE "p -> d")
execute_process(COMMAND @CMAKE_BINARY_DIR@/apps/openssl sess_id -in sid-f.p -inform p -outform d
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                OUTPUT_FILE sid-ff.d3
                COMMAND_ERROR_IS_FATAL ANY
)

# d -> t

# t -> t

# p -> t

message(NOTICE "d -> p")
execute_process(COMMAND @CMAKE_BINARY_DIR@/apps/openssl sess_id -in sid-f.d -inform d -outform p
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                OUTPUT_FILE sid-ff.p1
                COMMAND_ERROR_IS_FATAL ANY
)

# t -> p

message(NOTICE "p -> p")
execute_process(COMMAND @CMAKE_BINARY_DIR@/apps/openssl sess_id -in sid-f.p -inform p -outform p
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                OUTPUT_FILE sid-ff.p3
                COMMAND_ERROR_IS_FATAL ANY
)

execute_process(COMMAND @CMAKE_COMMAND@ -E compare_files --ignore-eol sid-fff.p sid-f.p
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                COMMAND_ERROR_IS_FATAL ANY
)

execute_process(COMMAND @CMAKE_COMMAND@ -E compare_files --ignore-eol sid-fff.p sid-ff.p1
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                COMMAND_ERROR_IS_FATAL ANY
)

# sid-fff.p sid-ff.p2

execute_process(COMMAND @CMAKE_COMMAND@ -E compare_files --ignore-eol sid-fff.p sid-ff.p3
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                COMMAND_ERROR_IS_FATAL ANY
)

# sid-f.t sid-ff.t1

# sid-f.t sid-ff.t2

# sid-f.t sid-ff.t3

# This is indeed the original logic of tsid logic. I don't know why they don't compare sid-f.d. Maybe that's just oversight.

execute_process(COMMAND @CMAKE_COMMAND@ -E compare_files --ignore-eol sid-f.p sid-ff.p1
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                COMMAND_ERROR_IS_FATAL ANY
)

# sid-f.p sid-ff.p2

execute_process(COMMAND @CMAKE_COMMAND@ -E compare_files --ignore-eol sid-f.p sid-ff.p3
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                COMMAND_ERROR_IS_FATAL ANY
)

# ... I think following are correct, isn't it? -- Fsu0413

execute_process(COMMAND @CMAKE_COMMAND@ -E compare_files --ignore-eol sid-f.d sid-ff.d1
             WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
             COMMAND_ERROR_IS_FATAL ANY
)

# sid-f.d sid-ff.d2

execute_process(COMMAND @CMAKE_COMMAND@ -E compare_files --ignore-eol sid-f.d sid-ff.d3
             WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
             COMMAND_ERROR_IS_FATAL ANY
)

execute_process(COMMAND @CMAKE_COMMAND@ -E rm -f sid-fff.p sid-f.d sid-f.p sid-ff.p1 sid-ff.p3 sid-ff.d1 sid-ff.d3
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
)
