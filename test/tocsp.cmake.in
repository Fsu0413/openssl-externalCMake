
execute_process(COMMAND @CMAKE_COMMAND@ -E copy_directory @CMAKE_SOURCE_DIR@/openssl/test/ocsp-tests ocsp-tests
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                COMMAND_ERROR_IS_FATAL ANY
)

if (WIN32)
    set(DEVNULL "NUL")
else()
    set(DEVNULL "/dev/null")
endif()

function(test_ocsp)
    execute_process(COMMAND @CMAKE_BINARY_DIR@/apps/openssl base64 -d -in ocsp-tests/${ARGV0}
                    WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                    RESULT_VARIABLE TEST_OCSP_RESULT
                    OUTPUT_FILE test_ocsp_pipe_${ARGV0}_1
                    )
    if (TEST_OCSP_RESULT EQUAL 0)
        execute_process(COMMAND @CMAKE_BINARY_DIR@/apps/openssl ocsp -respin - -partial_chain -attime 1355875200 -trusted_first -CAfile ocsp-tests/${ARGV1} -verify_other ocsp-tests/${ARGV1} -CApath ${DEVNULL}
                        WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
                        RESULT_VARIABLE TEST_OCSP_RESULT
                        INPUT_FILE test_ocsp_pipe_${ARGV0}_1
                        )
    endif()

    if (NOT TEST_OCSP_RESULT EQUAL ARGV2)
        message(FATAL_ERROR "tocsp failed: ${ARGV0} ${ARGV1} ${ARGV2}")
    endif()

    execute_process(COMMAND @CMAKE_COMMAND@ -E rm -f test_ocsp_pipe_${ARGV0}_1
                    WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
    )
endfunction()

message(NOTICE "=== VALID OCSP RESPONSES ===")
message(NOTICE "NON-DELEGATED; Intermediate CA -> EE")
test_ocsp(ND1.ors ND1_Issuer_ICA.pem 0)
message(NOTICE "NON-DELEGATED; Root CA -> Intermediate CA")
test_ocsp(ND2.ors ND2_Issuer_Root.pem 0)
message(NOTICE "NON-DELEGATED; Root CA -> EE")
test_ocsp(ND3.ors ND3_Issuer_Root.pem 0)
message(NOTICE "DELEGATED; Intermediate CA -> EE")
test_ocsp(D1.ors D1_Issuer_ICA.pem 0)
message(NOTICE "DELEGATED; Root CA -> Intermediate CA")
test_ocsp(D2.ors D2_Issuer_Root.pem 0)
message(NOTICE "DELEGATED; Root CA -> EE")
test_ocsp(D3.ors D3_Issuer_Root.pem 0)

message(NOTICE "=== INVALID SIGNATURE on the OCSP RESPONSE ===")
message(NOTICE "NON-DELEGATED; Intermediate CA -> EE")
test_ocsp(ISOP_ND1.ors ND1_Issuer_ICA.pem 1)
message(NOTICE "NON-DELEGATED; Root CA -> Intermediate CA")
test_ocsp(ISOP_ND2.ors ND2_Issuer_Root.pem 1)
message(NOTICE "NON-DELEGATED; Root CA -> EE")
test_ocsp(ISOP_ND3.ors ND3_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Intermediate CA -> EE")
test_ocsp(ISOP_D1.ors D1_Issuer_ICA.pem 1)
message(NOTICE "DELEGATED; Root CA -> Intermediate CA")
test_ocsp(ISOP_D2.ors D2_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Root CA -> EE")
test_ocsp(ISOP_D3.ors D3_Issuer_Root.pem 1)

message(NOTICE "=== WRONG RESPONDERID in the OCSP RESPONSE ===")
message(NOTICE "NON-DELEGATED; Intermediate CA -> EE")
test_ocsp(WRID_ND1.ors ND1_Issuer_ICA.pem 1)
message(NOTICE "NON-DELEGATED; Root CA -> Intermediate CA")
test_ocsp(WRID_ND2.ors ND2_Issuer_Root.pem 1)
message(NOTICE "NON-DELEGATED; Root CA -> EE")
test_ocsp(WRID_ND3.ors ND3_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Intermediate CA -> EE")
test_ocsp(WRID_D1.ors D1_Issuer_ICA.pem 1)
message(NOTICE "DELEGATED; Root CA -> Intermediate CA")
test_ocsp(WRID_D2.ors D2_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Root CA -> EE")
test_ocsp(WRID_D3.ors D3_Issuer_Root.pem 1)

message(NOTICE "=== WRONG ISSUERNAMEHASH in the OCSP RESPONSE ===")
message(NOTICE "NON-DELEGATED; Intermediate CA -> EE")
test_ocsp(WINH_ND1.ors ND1_Issuer_ICA.pem 1)
message(NOTICE "NON-DELEGATED; Root CA -> Intermediate CA")
test_ocsp(WINH_ND2.ors ND2_Issuer_Root.pem 1)
message(NOTICE "NON-DELEGATED; Root CA -> EE")
test_ocsp(WINH_ND3.ors ND3_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Intermediate CA -> EE")
test_ocsp(WINH_D1.ors D1_Issuer_ICA.pem 1)
message(NOTICE "DELEGATED; Root CA -> Intermediate CA")
test_ocsp(WINH_D2.ors D2_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Root CA -> EE")
test_ocsp(WINH_D3.ors D3_Issuer_Root.pem 1)

message(NOTICE "=== WRONG ISSUERKEYHASH in the OCSP RESPONSE ===")
message(NOTICE "NON-DELEGATED; Intermediate CA -> EE")
test_ocsp(WIKH_ND1.ors ND1_Issuer_ICA.pem 1)
message(NOTICE "NON-DELEGATED; Root CA -> Intermediate CA")
test_ocsp(WIKH_ND2.ors ND2_Issuer_Root.pem 1)
message(NOTICE "NON-DELEGATED; Root CA -> EE")
test_ocsp(WIKH_ND3.ors ND3_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Intermediate CA -> EE")
test_ocsp(WIKH_D1.ors D1_Issuer_ICA.pem 1)
message(NOTICE "DELEGATED; Root CA -> Intermediate CA")
test_ocsp(WIKH_D2.ors D2_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Root CA -> EE")
test_ocsp(WIKH_D3.ors D3_Issuer_Root.pem 1)

message(NOTICE "=== WRONG KEY in the DELEGATED OCSP SIGNING CERTIFICATE ===")
message(NOTICE "DELEGATED; Intermediate CA -> EE")
test_ocsp(WKDOSC_D1.ors D1_Issuer_ICA.pem 1)
message(NOTICE "DELEGATED; Root CA -> Intermediate CA")
test_ocsp(WKDOSC_D2.ors D2_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Root CA -> EE")
test_ocsp(WKDOSC_D3.ors D3_Issuer_Root.pem 1)

message(NOTICE "=== INVALID SIGNATURE on the DELEGATED OCSP SIGNING CERTIFICATE ===")
message(NOTICE "DELEGATED; Intermediate CA -> EE")
test_ocsp(ISDOSC_D1.ors D1_Issuer_ICA.pem 1)
message(NOTICE "DELEGATED; Root CA -> Intermediate CA")
test_ocsp(ISDOSC_D2.ors D2_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Root CA -> EE")
test_ocsp(ISDOSC_D3.ors D3_Issuer_Root.pem 1)

message(NOTICE "=== WRONG SUBJECT NAME in the ISSUER CERTIFICATE ===")
message(NOTICE "NON-DELEGATED; Intermediate CA -> EE")
test_ocsp(ND1.ors WSNIC_ND1_Issuer_ICA.pem 1)
message(NOTICE "NON-DELEGATED; Root CA -> Intermediate CA")
test_ocsp(ND2.ors WSNIC_ND2_Issuer_Root.pem 1)
message(NOTICE "NON-DELEGATED; Root CA -> EE")
test_ocsp(ND3.ors WSNIC_ND3_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Intermediate CA -> EE")
test_ocsp(D1.ors WSNIC_D1_Issuer_ICA.pem 1)
message(NOTICE "DELEGATED; Root CA -> Intermediate CA")
test_ocsp(D2.ors WSNIC_D2_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Root CA -> EE")
test_ocsp(D3.ors WSNIC_D3_Issuer_Root.pem 1)

message(NOTICE "=== WRONG KEY in the ISSUER CERTIFICATE ===")
message(NOTICE "NON-DELEGATED; Intermediate CA -> EE")
test_ocsp(ND1.ors WKIC_ND1_Issuer_ICA.pem 1)
message(NOTICE "NON-DELEGATED; Root CA -> Intermediate CA")
test_ocsp(ND2.ors WKIC_ND2_Issuer_Root.pem 1)
message(NOTICE "NON-DELEGATED; Root CA -> EE")
test_ocsp(ND3.ors WKIC_ND3_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Intermediate CA -> EE")
test_ocsp(D1.ors WKIC_D1_Issuer_ICA.pem 1)
message(NOTICE "DELEGATED; Root CA -> Intermediate CA")
test_ocsp(D2.ors WKIC_D2_Issuer_Root.pem 1)
message(NOTICE "DELEGATED; Root CA -> EE")
test_ocsp(D3.ors WKIC_D3_Issuer_Root.pem 1)

message(NOTICE "=== INVALID SIGNATURE on the ISSUER CERTIFICATE ===")
# Expect success, because we're explicitly trusting the issuer certificate.
message(NOTICE "NON-DELEGATED; Intermediate CA -> EE")
test_ocsp(ND1.ors ISIC_ND1_Issuer_ICA.pem 0)
message(NOTICE "NON-DELEGATED; Root CA -> Intermediate CA")
test_ocsp(ND2.ors ISIC_ND2_Issuer_Root.pem 0)
message(NOTICE "NON-DELEGATED; Root CA -> EE")
test_ocsp(ND3.ors ISIC_ND3_Issuer_Root.pem 0)
message(NOTICE "DELEGATED; Intermediate CA -> EE")
test_ocsp(D1.ors ISIC_D1_Issuer_ICA.pem 0)
message(NOTICE "DELEGATED; Root CA -> Intermediate CA")
test_ocsp(D2.ors ISIC_D2_Issuer_Root.pem 0)
message(NOTICE "DELEGATED; Root CA -> EE")
test_ocsp(D3.ors ISIC_D3_Issuer_Root.pem 0)

message(NOTICE "ALL OCSP TESTS SUCCESSFUL")

execute_process(COMMAND @CMAKE_COMMAND@ -E rm -rf ocsp-tests
                WORKING_DIRECTORY @CMAKE_CURRENT_BINARY_DIR@
)
